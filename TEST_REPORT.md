# Отчет о ручном тестировании

## Окружение
- **Дата:** 18.11.2025
- **Версия:** Dev stack (backend)
- **Инструменты:** Скрипт `qa_check.py` (requests), Docker logs, manual verification.

## Общая оценка
Сервис запускается, миграции применяются. Основной бизнес-сценарий (Happy Path) работает: создание контактов, сделок, задач и аналитика. 
Однако выявлены **блокирующие архитектурные ошибки** в механизме выбора организации (Discovery) и **критическое отсутствие функционала** по управлению участниками (невозможно добавить пользователей в организацию).

## Детальные результаты

| ID | Описание | Статус | Ожидаемое поведение | Фактическое поведение | Критичность |
|----|----------|--------|---------------------|-----------------------|-------------|
| 1 | Регистрация пользователя | **PASS** | 200/201 + токены | 201 Created, токены получены | - |
| 2 | Логин (получение токена) | **PASS** | 200 OK + токен | 200 OK, токен получен | - |
| 3 | Получение списка организаций (`GET /organizations/me`) | **FAILED** | Список организаций пользователя | **400 Bad Request: X-Organization-Id header required**. Невозможно узнать ID организации для подстановки в заголовок, так как этот эндпоинт требует сам заголовок. | **Blocker** |
| 4 | Создание контакта | **PASS** | 201 Created | 201 Created (при ручной подстановке ID) | - |
| 5 | Создание сделки | **PASS** | 201 Created | 201 Created | - |
| 6 | Смена статуса сделки (на WON) | **PASS** | 200 OK + Activity | 200 OK, активность `status_changed` создана | - |
| 7 | Аналитика (Summary/Funnel) | **PASS** | Корректные данные | 200 OK, данные возвращаются | - |
| 8 | Валидация задачи (дата в прошлом) | **PASS** | 400/422 Error | 400/422 (Validation Error) | - |
| 9 | Валидация сделки (WON при amount=0) | **PASS** | 400 Error | 400 Error | - |
| 10 | Регистрация с дубликатом имени организации | **FAILED** | 409 Conflict | **500 Internal Server Error**. "Сырой" трейсбек базы данных (`IntegrityError`). | **Major** |
| 11 | Добавление участника в организацию | **MISSING** | API endpoint (invite/add) | Отсутствует в коде и документации. Невозможно добавить коллег. | **Critical** |

## Найденные дефекты

### 1. Циклическая зависимость в `GET /organizations/me` (Blocker)
Эндпоинт, предназначенный для *получения* ID организаций, требует наличие ID организации в заголовке `X-Organization-Id`.
- **Причина:** Использование глобальной зависимости `get_request_context` (которая проверяет хедер) вместо `get_request_user` или специфичной для этого эндпоинта логики.
- **Последствие:** Клиент не может узнать ID своих организаций после логина.

### 2. Отсутствие управления участниками (Critical)
В ТЗ заявлена многопользовательская работа и роли (owner, admin, manager, member).
- **Факт:** Реализована только регистрация (создает Owner). Нет API для добавления других пользователей.
- **Последствие:** Невозможно протестировать ролевую модель и многопользовательские сценарии внутри одной организации.

### 3. Необработанная ошибка дубликата (Major)
При регистрации с занятым именем организации сервер падает с 500 ошибкой.
- **Ожидание:** 409 Conflict с понятным сообщением.
- **Факт:** `sqlalchemy.exc.IntegrityError` вываливается наружу.

## Рекомендации
1. **Fix `/organizations/me`:** Изменить зависимости эндпоинта, чтобы он требовал только валидный токен, но не контекст организации.
2. **Implement Members API:** Добавить эндпоинты `POST /organizations/{id}/members` (приглашение по email).
3. **Error Handling:** Обернуть создание организации в `try/except IntegrityError` и возвращать 409.
